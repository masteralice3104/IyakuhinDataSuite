# 💊 医薬品データ統合システム (IyakuhinDataSuite)

医薬品コードデータ（MEDHOT、HOTコードマスター、PMDA）を統合し、GS1包装単位コード⇔YJコード（個別医薬品コード）の双方向変換とWebビューアーを提供するシステムです。

## ✨ 主な機能

### 🚀 全自動セットアップ（推奨）
- **初回実行時はこれだけでOK！**
- データ収集からビューアー生成までを全自動で実行
- 所要時間: 約10〜15分

### 📥 データ収集・統合
- **MEDHOT**: 調剤・販売・元梱包装単位コード
- **HOTコードマスター（MEDIS）**: 個別医薬品コードと薬価基準収載医薬品コード
- **PMDA**: 医薬品のサイズ情報（長径・短径・直径・厚さ）

### 🔄 双方向コード変換
- **GS1包装単位コード → YJコード**（販売名フィルタリング付き）
- **YJコード → GS1包装単位コード**（複数パターン対応）
- 循環変換テスト機能（精度検証用）

### 🌐 Webビューアー
- **通常版**: HTTPサーバーで起動
- **スタンドアロン版**: サーバー不要の単一HTMLファイル（12.7MB）
- マルチキーワード検索、フィルタリング、ソート機能
- IE11対応（ES5互換）

## 📦 クイックスタート

### 1. 初回セットアップ（全自動）

#### 推奨方法: BATファイルから起動（UTF-8保証）
```batch
# main.bat をダブルクリック、または
main.bat

# [0] 全自動セットアップ を選択
```

#### または: PowerShellから直接起動
```powershell
# メインメニューを起動
.\main.ps1

# [0] 全自動セットアップ を選択
```

これだけで以下が完了します：
1. MEDHOT/HOT/PMDAデータの収集
2. データの処理・CSV化
3. JSON統合ファイル生成（24,128件）
4. スタンドアロン版ビューアー生成

### 2. ビューアーを使う

#### 方法A: スタンドアロン版（簡単）
```
output\drug_viewer_standalone.html をダブルクリック
```

#### 方法B: HTTPサーバー版
```powershell
.\main.ps1
# [3] ビューアー起動 → [1] HTTPサーバー起動
```

## 📂 プロジェクト構成

```
IyakuhinDataSuite/
├── main.bat                    # UTF-8起動用BATファイル（推奨）
├── main.ps1                    # メインメニュー
├── scripts/                    # 各種スクリプト
│   ├── medhot_get.ps1         # MEDHOTデータ取得
│   ├── hotcode_get.ps1        # HOTコードマスター取得
│   ├── pmda_get.ps1           # PMDAデータ取得
│   ├── code_bidirectional.ps1 # 双方向コード変換
│   ├── generate_drug_json.ps1 # JSON統合
│   └── generate_standalone_viewer.ps1
├── csv/                        # 処理済みCSVデータ
│   ├── medhot.csv
│   ├── MEDIS20250930.csv
│   └── pmda.csv
├── output/                     # 生成ファイル
│   ├── drug_data.json         # 統合JSONデータ（12.67MB）
│   ├── drug_viewer.html       # 通常版ビューアー
│   └── drug_viewer_standalone.html  # スタンドアロン版（12.7MB）
├── raw/                        # ダウンロード生データ
└── pmda_zip/                   # PMDAのZIPファイル配置場所
```

## 🎯 使い方

### メインメニューから実行

#### 推奨: BATファイルから
```batch
main.bat
```
- UTF-8エンコーディングを保証
- 文字化けを防止
- ダブルクリックでも起動可能

#### または: PowerShellから
```powershell
.\main.ps1
```

#### 📋 メニュー項目

```
🚀 [0] 全自動セットアップ（推奨・初回実行）
    └─ すべてを一括実行

📥 [1] データ収集・更新
    └─ 個別またはまとめてデータ取得

📄 [2] JSON生成
    └─ CSV→JSON統合ファイル作成

🌐 [3] ビューアー起動
    ├─ HTTPサーバー起動
    ├─ スタンドアロン版生成
    └─ スタンドアロン版を開く

🔄 [4] コード変換
    ├─ 単一コード変換（GS1⇔YJ）
    └─ 循環変換テスト（1000件）

ℹ️  [5] システム情報
    └─ ファイル状況・スクリプト一覧
```

### 個別スクリプトの実行

必要に応じて個別実行も可能です：

```powershell
# データ収集のみ
.\scripts\medhot_get.ps1
.\scripts\hotcode_get.ps1
.\scripts\pmda_get.ps1

# JSON生成のみ
.\scripts\generate_drug_json.ps1

# コード変換（対話式）
.\scripts\code_bidirectional.ps1 -Code 04987934648347

# 循環変換テスト
.\scripts\code_bidirectional.ps1 -Test
```

## 📊 データ統計

### 統合JSONファイル
- **総レコード数**: 24,128件
- **GS1コード保有**: 22,879件（94.8%）
- **PMDAサイズ情報**: 5,284件（21.9%）
- **ファイルサイズ**: 12.67 MB

### 各データソース
| データソース | ファイル名        | 内容                                       |
| ------------ | ----------------- | ------------------------------------------ |
| MEDHOT       | medhot.csv        | 調剤・販売・元梱包装単位コード             |
| MEDIS        | MEDIS20250930.csv | 個別医薬品コード・薬価基準収載医薬品コード |
| PMDA         | pmda.csv          | 医薬品サイズ情報                           |

## 🔧 技術仕様

### 環境要件
- **PowerShell**: 5.1以上（7.x推奨）
- **OS**: Windows 10/11
- **.NET Framework**: 4.7.2以上（HttpListener使用）

### UTF-8対応について
プロジェクトは完全UTF-8で構築されています。

#### main.bat の仕組み
```batch
@echo off
chcp 65001 >nul          # UTF-8コードページに設定
cd /d "%~dp0"            # スクリプトのディレクトリに移動
powershell.exe -NoProfile -ExecutionPolicy Bypass -File "main.ps1"
pause                    # 実行後、キー入力待ち
```

**推奨事項**:
- ✅ `main.bat` を使用（文字化け防止）
- ⚠️ PowerShellから直接実行する場合は、コンソールのエンコーディングを確認
- 💡 **重要**: `main.ps1` は **UTF-8 BOM付き** で保存されています
  - これにより、BATファイルからの起動時に文字化けを防止
  - エディタで編集する場合は、エンコーディングを変更しないでください

### データフロー

```
[外部ソース]
    ↓ ダウンロード
[raw/]
    ↓ 処理・正規化
[csv/]
    ↓ 統合・JSON化
[output/drug_data.json]
    ↓ ビューアー生成
[output/drug_viewer_standalone.html]
```

### 双方向変換アルゴリズム

#### GS1 → YJ 変換
1. GS1コードから薬価基準収載医薬品コードを取得（MEDHOT）
2. 薬価基準コードから候補YJコードを取得（MEDIS）
3. **販売名による絞り込み**（統一名収載品対策）
4. 複数候補がある場合はリスト表示

#### YJ → GS1 変換
1. YJコードから薬価基準収載医薬品コードを取得（MEDIS）
2. 薬価基準コードからGS1コードを取得（MEDHOT）
3. **販売名による絞り込み**
4. 調剤・販売・元梱の全パターンを返却

#### 統一名収載品への対応
- 末尾が `01*` のYJコードは複数メーカーに対応
- 販売名フィルタリングにより正確な変換を実現
- 循環変換テスト: **1000/1000件成功（100%精度）**

## 🌐 Webビューアー機能

### 検索機能
- **マルチキーワード検索**: スペース区切りでAND検索
  ```
  例: 炭酸リチウム 大正
  ```
- **検索対象**:
  - YJコード（個別医薬品コード）
  - 販売名
  - 薬価基準収載医薬品コード
  - 全GS1コード（調剤・販売・元梱）

### フィルタ・ソート
- **フィルタ**: 全て / GS1あり / PMDAサイズあり
- **ソート**: 販売名順 / コード順

### ブラウザ互換性
- **モダンブラウザ**: Chrome, Edge, Firefox, Safari
- **レガシー**: IE11対応（ES5互換・ポリフィル実装）

## 📝 更新履歴

### v2.1（2025-10-11）
- 📝 UTF-8起動用BATファイル追加（main.bat）
- 🔧 文字化け防止対策を実装

### v2.0（2025-10-11）
- ✨ 全自動セットアップ機能追加
- 🎨 グラフィカルCUIメニューに改善
- 📁 スクリプトをscripts/フォルダに整理
- 🔧 パス設定をプロジェクトルート基準に統一

### v1.0（初版）
- 双方向コード変換
- JSON統合
- Webビューアー（通常版・スタンドアロン版）
- 循環変換テスト（100%精度達成）

## 📖 参考資料

- [MEDHOT医薬品コード](https://medhot.medd.jp/)
- [医薬品HOTコードマスター（MEDIS）](https://www2.medis.or.jp/hcode/)
- [PMDA（医薬品医療機器総合機構）](https://www.pmda.go.jp/)

## 📄 ライセンス

このプロジェクトは個人・組織での利用を想定しています。
各データソースの利用規約に従ってご使用ください。

## 🤝 サポート

問題が発生した場合：
1. `.\main.ps1` → [5] システム情報 でファイル状況を確認
2. 必要に応じて [1] データ収集・更新 を再実行
3. それでも解決しない場合は [0] 全自動セットアップ を再実行

---

**Made with ❤️ for 医薬品データ管理**
