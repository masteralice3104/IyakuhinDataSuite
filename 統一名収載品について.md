# 統一名収載品について

## 概要
薬価コード（YJコード）の末尾3桁が `01*` のものは、**統一名収載品**の薬価コードであり、個別医薬品コードではありません。

## 薬価コードの構造
- **12桁の薬価コード**: `XXXX-XXX-XXXX` の形式
- **末尾3桁**: 最後の4桁のうち前2桁が重要
  - `01*`: 統一名収載品（generic name product）
  - `01以外`: 個別医薬品コード（YJコード）

## 例
### 統一名収載品（除外すべき）
```
2171022F4010
        ^^
        01 = 統一名収載品
```

### 個別医薬品コード（使用可能）
```
2171022F6250
        ^^
        25 = 個別医薬品コード
```

```
2171022F4036
        ^^
        03 = 個別医薬品コード
```

## コード変換への影響
### 修正前の問題
- 統一名収載品（末尾01*）がMEDISで複数の異なるメーカーの個別医薬品コードにマッピングされる
- 逆変換時に、異なるメーカーの製品が混在してしまう
- 例: `2171022F4010`（統一名収載品）→ 22種類の異なるメーカーの個別医薬品コード

### 修正後の動作
- **販売名フィルタリング**を実装
- 包装→個別: MEDHOTの販売名とMEDISの販売名を照合し、一致するもののみ返す
- 個別→包装: MEDISで販売名を取得し、同じ販売名のMEDHOTレコードのみ返す
- 統一名収載品でも、販売名が一致する個別医薬品コードのみが変換結果に含まれる

## 実装
`code_bidirectional.ps1`では販売名によるフィルタリングを実装:

```powershell
# 包装単位コード → 個別医薬品コード
# MEDHOTの販売名とMEDISの販売名を照合
$medisRow = $medisData | Where-Object { 
    $_.'個別医薬品コード' -eq $yjcode -and 
    $_.'薬価基準収載医薬品コード' -eq $yakkakijun 
} | Select-Object -First 1

if ($medisRow -and $medisRow.'販売名' -eq $productName) {
    # 販売名が一致する個別医薬品コードのみ返す
}

# 個別医薬品コード → 包装単位コード
# MEDISで販売名を取得
$productName = $medisRow.'販売名'

# 同じ販売名のMEDHOTレコードのみ検索
$matchedRows = $medhotData | Where-Object { 
    $_.'薬価コード' -eq $yakkakijun -and 
    $_.'販売名' -eq $productName 
}
```

## テスト結果
### 統一名収載品（販売名でフィルタリング）
```
入力: 14987885026666 (販売包装単位コード)
薬価コード: 2171022F4010 (末尾01 = 統一名収載品)
販売名: アムロジピンOD錠5mg「トーワ」
結果: 成功 - 1件のみ（2171022F4036）、販売名が一致
```

### 循環変換テスト
```
14987885026666 (販売包装単位コード)
  ↓ 変換
2171022F4036 (個別医薬品コード) - アムロジピンOD錠5mg「トーワ」
  ↓ 逆変換
18件の包装単位コード（すべて「トーワ」）
  ↓ 14987885026666を含む
✓ 循環変換成功
```

### 販売名フィルタリングの効果
```
修正前: 2171022F4036 → 350件（明治、サンド、NP、ファイザー、TCK、トーワなど混在）
修正後: 2171022F4036 → 18件（すべて「トーワ」のみ）
```

## 参考
- 統一名収載品は、後発医薬品の薬価基準収載時に使用される統一的な名称
- 個別医薬品コード（YJコード）は、各製造販売会社の個別製品に割り当てられる
